<template>
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <header class="border-b border-border bg-card/50 backdrop-blur-sm sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <Button variant="ghost" size="sm" as-child>
              <router-link :to="`/item/${itemId}`">
                <ArrowLeft class="h-4 w-4 mr-2" />
                Back to Item
              </router-link>
            </Button>
            <div class="flex items-center gap-2">
              <div class="h-8 w-8 rounded-lg bg-primary flex items-center justify-center">
                <span class="text-primary-foreground font-bold text-sm">PS</span>
              </div>
              <h1 class="text-xl font-bold text-foreground">PeerSwap</h1>
            </div>
          </div>
          <Button variant="outline" size="sm" as-child>
            <router-link to="/profile">Profile</router-link>
          </Button>
        </div>
      </div>
    </header>

    <!-- Loading -->
    <div v-if="loading" class="container mx-auto px-4 py-6 text-center">
      <p>Loading item details...</p>
    </div>

    <!-- Content -->
    <div v-else-if="item" class="container mx-auto px-4 py-6 max-w-4xl">
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-foreground mb-2">Request Rental</h2>
        <p class="text-muted-foreground">Send a rental request to the item owner</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Form Column -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Item Summary -->
          <Card>
            <CardHeader>
              <CardTitle>Item Details</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="flex gap-4">
                <img
                  :src="item.image"
                  :alt="item.title"
                  class="w-24 h-24 rounded-lg object-cover"
                />
                <div class="flex-1">
                  <h3 class="font-semibold text-lg mb-2">{{ item.title }}</h3>
                  <div class="flex items-center gap-4 text-sm text-muted-foreground mb-2">
                    <Badge variant="outline">{{ item.category }}</Badge>
                    <Badge variant="secondary">{{ item.condition }}</Badge>
                    <span>${{ item.price }}/{{ item.period }}</span>
                  </div>
                  <p class="text-sm text-muted-foreground">{{ item.description }}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <!-- Owner Info -->
          <Card>
            <CardHeader>
              <CardTitle>Item Owner</CardTitle>
            </CardHeader>
            <CardContent>
              <div class="flex items-center gap-4">
                <Avatar class="h-12 w-12">
                  <AvatarImage :src="item.ownerAvatar" />
                  <AvatarFallback>{{ getInitials(item.ownerName) }}</AvatarFallback>
                </Avatar>
                <div class="flex-1">
                  <h4 class="font-semibold">{{ item.ownerName }}</h4>
                  <p class="text-sm text-muted-foreground">
                    Listed by user <span class="font-medium">{{ item.ownerId }}</span>
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          <!-- Rental Details Form -->
          <Card>
            <CardHeader>
              <CardTitle>Rental Details</CardTitle>
              <CardDescription>Specify your rental duration and message</CardDescription>
            </CardHeader>
            <CardContent class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <Label for="startDate">Start Date</Label>
                  <div class="relative">
                    <Calendar class="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                    <Input id="startDate" v-model="startDate" type="date" class="pl-10" :min="minDate" />
                  </div>
                </div>

                <div class="space-y-2">
                  <Label for="endDate">End Date</Label>
                  <div class="relative">
                    <Calendar class="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                    <Input id="endDate" v-model="endDate" type="date" class="pl-10" :min="startDate || minDate" />
                  </div>
                </div>
              </div>

              <div class="space-y-2">
                <Label for="duration">Duration (weeks)</Label>
                <div class="relative">
                  <Clock class="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                  <Input
                    id="duration"
                    v-model.number="duration"
                    type="number"
                    class="pl-10"
                    :min="item.minRentalPeriod"
                    :max="item.maxRentalPeriod"
                  />
                </div>
                <p class="text-xs text-muted-foreground">
                  Minimum: {{ item.minRentalPeriod }} week(s), Maximum: {{ item.maxRentalPeriod }} week(s)
                </p>
              </div>

              <div class="space-y-2">
                <Label for="message">Message to Owner</Label>
                <Textarea
                  id="message"
                  v-model="message"
                  placeholder="Introduce yourself and explain why you need this item."
                  :rows="4"
                  maxlength="500"
                />
                <p class="text-xs text-muted-foreground">{{ message.length }}/500 characters</p>
              </div>
            </CardContent>
          </Card>
        </div>

        <!-- Summary Column -->
        <div class="lg:col-span-1">
          <Card class="sticky top-24">
            <CardHeader>
              <CardTitle>Rental Summary</CardTitle>
            </CardHeader>
            <CardContent class="space-y-4">
              <div class="space-y-3">
                <div class="flex justify-between text-sm">
                  <span>Rental cost ({{ duration }} week{{ duration !== 1 ? 's' : '' }})</span>
                  <span>${{ totalRentalCost }}</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Security deposit</span>
                  <span>${{ item.securityDeposit }}</span>
                </div>
                <Separator />
                <div class="flex justify-between font-semibold">
                  <span>Total</span>
                  <span>${{ totalCost }}</span>
                </div>
              </div>

              <div class="bg-muted/50 p-3 rounded-lg">
                <div class="flex items-start gap-2">
                  <Shield class="h-4 w-4 text-primary mt-0.5" />
                  <div class="text-xs">
                    <p class="font-medium mb-1">Security Deposit</p>
                    <p class="text-muted-foreground">
                      Fully refunded when the item is returned in good condition.
                    </p>
                  </div>
                </div>
              </div>

              <Button
                class="w-full"
                size="lg"
                @click="handleSubmitRequest"
                :disabled="!isFormValid || submitting"
              >
                {{ submitting ? 'Sending Request...' : 'Send Rental Request' }}
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
// Core Vue
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'

// UI Components
import { Calendar, Shield, ArrowLeft, Clock } from 'lucide-vue-next'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Separator } from '@/components/ui/separator'

// Firebase
import { auth, db } from '@/firebase'
import { doc, getDoc, collection, addDoc, serverTimestamp } from 'firebase/firestore'

// Router & State
const route = useRoute()
const router = useRouter()
const itemId = route.params.id
const loading = ref(true)
const submitting = ref(false)
const item = ref(null)
const startDate = ref('')
const endDate = ref('')
const message = ref('')
const duration = ref(1)

// Computed
const minDate = computed(() => new Date().toISOString().split('T')[0])
const totalRentalCost = computed(() => item.value ? item.value.price * duration.value : 0)
const totalCost = computed(() => item.value ? totalRentalCost.value + item.value.securityDeposit : 0)
const isFormValid = computed(() =>
  startDate.value &&
  endDate.value &&
  message.value.trim().length > 0 &&
  duration.value >= (item.value?.minRentalPeriod || 1) &&
  duration.value <= (item.value?.maxRentalPeriod || 4)
)

// Helpers
const getInitials = (name) => name?.split(' ').map(n => n[0]).join('') || '?'

// Submit rental request
const handleSubmitRequest = async () => {
  if (!isFormValid.value) return alert('Please complete all required fields.')

  const user = auth.currentUser
  if (!user) {
    alert('You must be logged in to send a request.')
    return router.push('/login')
  }

  submitting.value = true
  try {
    const rentalData = {
      title: item.value.title,
      photoUrl: item.value.image || '',
      borrowerId: user.uid,
      borrowerName: user.displayName || 'Anonymous',
      lenderId: item.value.ownerId,
      lenderName: item.value.ownerName,
      itemId: itemId,
      startDate: startDate.value,
      endDate: endDate.value,
      duration: duration.value,
      message: message.value,
      totalRentalCost: totalRentalCost.value,
      securityDeposit: item.value.securityDeposit,
      totalCost: totalCost.value,
      status: 'Pending',
      createdAt: serverTimestamp()
    }

    await addDoc(collection(db, 'rentals'), rentalData)

    alert('Rental request sent successfully!')
    router.push('/rentals')
  } catch (err) {
    console.error('Error submitting rental request:', err)
    alert('Error sending rental request. Please try again.')
  } finally {
    submitting.value = false
  }
}

// Fetch item details from Firestore
onMounted(async () => {
  try {
    const docRef = doc(db, 'listings', itemId)
    const docSnap = await getDoc(docRef)

    if (docSnap.exists()) {
      const data = docSnap.data()
      item.value = {
        id: docSnap.id,
        title: data.title,
        description: data.description,
        price: data.price,
        period: data.period,
        category: data.category,
        condition: data.condition,
        image: data.image,
        ownerId: data.ownerId,
        ownerName: data.ownerName,
        ownerAvatar: data.ownerAvatar || '/default-user.png',
        securityDeposit: data.securityDeposit || 0,
        minRentalPeriod: data.minRentalPeriod || 1,
        maxRentalPeriod: data.maxRentalPeriod || 4
      }
    } else {
      alert('Item not found.')
      router.push('/browse')
    }
  } catch (error) {
    console.error('Error fetching item:', error)
    alert('Unable to load item details.')
  } finally {
    loading.value = false
  }
})
</script>

<style scoped>
/* Optional styling */
</style>
